<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能玻璃切割优化软件系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <!-- 添加 Font Awesome 图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
      /* 通用头部样式 */
.main-header {
    background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.brand-area {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.brand-logo {
    font-size: 2rem;
    color: white;
}

.brand-text h1 {
    font-size: 1.5rem;
    margin: 0;
}

.brand-slogan {
    font-size: 0.9rem;
    opacity: 0.9;
}

.nav-area {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
}

.nav-link {
    color: white;
    text-decoration: none;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
}

.nav-link:hover {
    background: rgba(255,255,255,0.1);
    color: white;
}

.nav-link.active {
    background: rgba(255,255,255,0.2);
}

/* 页面副标题区域 */
.page-subtitle {
    text-align: center;
    margin-bottom: 3rem;
    padding: 2rem;
    background: #f8f9fa;
    border-radius: 10px;
}

.page-subtitle h2 {
    color: #2c3e50;
    margin-bottom: 1rem;
}

.page-subtitle p {
    color: #666;
    max-width: 800px;
    margin: 0 auto;
}

/* 统一的页脚样式 */
.main-footer {
    background: #2c3e50;
    color: white;
    padding: 3rem 0 2rem;
    margin-top: 4rem;
}

.footer-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
}

.footer-section h3 {
    font-size: 1.2rem;
    margin-bottom: 1rem;
    color: #3498db;
}

.footer-section ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.footer-section ul li {
    margin-bottom: 0.5rem;
}

.footer-section a {
    color: rgba(255,255,255,0.8);
    text-decoration: none;
    transition: color 0.3s ease;
}

.footer-section a:hover {
    color: white;
}

.footer-bottom {
    text-align: center;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid rgba(255,255,255,0.1);
}

/* 响应式调整 */
@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        text-align: center;
        gap: 1.5rem;
        padding: 1rem 0;
    }

    .nav-area {
        width: 100%;
        justify-content: center;
        gap: 0.5rem;
        flex-direction: column;
        padding: 0 1rem;
    }

    .nav-link {
        justify-content: center;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .nav-link i {
        font-size: 1rem;
    }

    .brand-area {
        width: 100%;
        justify-content: center;
    }

    .brand-text h1 {
        font-size: 1.25rem;
    }

    .brand-slogan {
        font-size: 0.8rem;
    }

    .footer-content {
        grid-template-columns: 1fr;
        text-align: center;
    }
}

/* 适配超小屏幕 */
@media (max-width: 360px) {
    .nav-area {
        padding: 0 0.5rem;
    }

    .nav-link {
        padding: 0.5rem;
        font-size: 0.8rem;
    }

    .brand-text h1 {
        font-size: 1.1rem;
    }
}

    </style>
    <style>
        .pain-points {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .optimization-container {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
        }

        .visualization-area {
            flex: 2;
            min-width: 300px;
        }

        .input-area {
            flex: 1;
            min-width: 300px;
        }

        .stats-area {
            width: 100%;
            margin-top: 2rem;
        }

        .cutting-canvas {
            border: 2px solid #fff;
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .optimization-container {
                flex-direction: column;
            }

            .visualization-area,
            .input-area {
                width: 100%;
            }
        }

        .result-tabs {
            margin-top: 2rem;
        }

        .material-item {
            background: #f8f9fa;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }

        .cutting-list-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .btn-icon {
            padding: 0.375rem 0.75rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-icon i {
            font-size: 1rem;
        }

        .cutting-plan-container {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .canvas-wrapper {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .progress {
            margin-top: 5px;
        }

        .table-sm td {
            padding: 0.3rem;
            font-size: 0.875rem;
        }

.nav-link1 {
    color: #666;
}
.nav-link1:hover {
    color: #333;
}
    </style>
</head>
<body>
  <header class="main-header">
    <div class="container">
      <div class="header-content">
        <div class="brand-area">
          <div class="brand-logo">
            <i class="fas fa-cut"></i>
          </div>
          <div class="brand-text">
            <h1>智能切割优化软件系统</h1>
            <div class="brand-slogan">让切割更智能 · 为企业创造价值</div>
          </div>
        </div>
        <nav class="nav-area">
          <a href="index.html" class="nav-link">
            <i class="fas fa-home"></i> 首页
          </a>
          <a href="plasticsteelcutting.html" class="nav-link">
            <i class="fas fa-window-maximize"></i> 门窗切割优化
          </a>
          <a href="materialusage.html" class="nav-link">
            <i class="fas fa-crop"></i> 玻璃切割优化
          </a>
        </nav>
      </div>
    </div>
  </header>
  
  <div class="page-subtitle">
    <div class="container">
      <h2>专业切割优化解决方案</h2>
      <p>运用智能算法为企业降本增效，实现精准切割、降低损耗、提升效率</p>
    </div>
  </div>

    <div class="container-fluid py-4">
        <!-- 行业痛点展示区 -->
        <!-- <section class="pain-points">
            <h2 class="text-center mb-4">玻璃切割行业痛点解决方案</h2>
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">材料浪费严重</h5>
                            <p class="card-text">传统人工排版方式材料利用率低，造成30%以上的材料浪费。</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">人工成本高</h5>
                            <p class="card-text">排版人员需要大量经验，培训周期长，人工成本高。</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">效率低下</h5>
                            <p class="card-text">人工排版耗时长，难以快速响应客户需求。</p>
                        </div>
                    </div>
                </div>
            </div>
        </section> -->

        <!-- 主要操作区域 -->
        <div class="optimization-container">
            <!-- 输入区域 -->
            <div class="input-area">
                <h3>参数设置</h3>
                <div class="card">
                    <div class="card-body">
                        <h5>原材料尺寸</h5>
                        <div id="materialList">
                            <div class="material-item">
                                <div class="input-group mb-2">
                                    <input type="number" class="form-control" placeholder="长度(mm)">
                                    <input type="number" class="form-control" placeholder="宽度(mm)">
                                    <button class="btn btn-outline-danger btn-icon delete-material">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary btn-icon" id="addMaterial">
                            <i class="fas fa-plus me-2"></i>添加原材料
                        </button>

                        <h5 class="mt-4">切割清单</h5>
                        <div id="cuttingList">
                            <div class="cutting-list-item">
                                <input type="number" class="form-control" placeholder="长度(mm)">
                                <input type="number" class="form-control" placeholder="宽度(mm)">
                                <input type="number" class="form-control" placeholder="数量">
                                <button class="btn btn-outline-danger btn-icon delete-cutting">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        <button class="btn btn-primary btn-icon mt-2" id="addCuttingItem">
                            <i class="fas fa-plus me-2"></i>添加切割项
                        </button>

                        <div class="advanced-settings mt-4">
                            <h5>
                                高级参数设置
                                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#advancedParams">
                                    <i class="fas fa-cog"></i>
                                </button>
                            </h5>
                            <div class="collapse" id="advancedParams">
                                <div class="card card-body">
                                    <div class="mb-3">
                                        <label class="form-label">切割余量(mm)</label>
                                        <input type="number" class="form-control" id="cuttingGap" value="1" min="0" step="0.1">
                                        <small class="text-muted">设置切割工具的宽度，影响实际可用面积</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">最小可重用边角料尺寸(mm)</label>
                                        <input type="number" class="form-control" id="minScrapSize" value="50" min="10">
                                        <small class="text-muted">小于此尺寸的边角料将被视为废料</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">评分权重设置</label>
                                        <div class="input-group mb-2">
                                            <span class="input-group-text">面积利用率</span>
                                            <input type="number" class="form-control" id="areaWeight" value="0.4" min="0" max="1" step="0.1">
                                        </div>
                                        <div class="input-group mb-2">
                                            <span class="input-group-text">边缘对齐</span>
                                            <input type="number" class="form-control" id="alignmentWeight" value="0.3" min="0" max="1" step="0.1">
                                        </div>
                                        <div class="input-group">
                                            <span class="input-group-text">废料最小化</span>
                                            <input type="number" class="form-control" id="wasteWeight" value="0.3" min="0" max="1" step="0.1">
                                        </div>
                                        <small class="text-muted">三项权重之和应等于1</small>
                                    </div>
                                    <button class="btn btn-outline-secondary" id="resetParams">
                                        <i class="fas fa-undo me-2"></i>恢复默认值
                                    </button>
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-success w-100 mt-4" id="calculateBtn">
                            <i class="fas fa-calculator me-2"></i>开始优化计算
                        </button>
                    </div>
                </div>
            </div>

            <!-- 可视化区域 -->
            <div class="visualization-area">
                <!-- 移动统计信息区域到这里 -->
                <div class="stats-area mb-4">
                    <h3>优化结果统计</h3>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">材料利用率</h5>
                                    <p class="card-text" id="utilizationRate">--</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">损耗率</h5>
                                    <p class="card-text" id="wasteRate">--</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">原材料使用量</h5>
                                    <p class="card-text" id="materialUsage">--</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">预计节省成本</h5>
                                    <p class="card-text" id="costSaving">--</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <h3>切割方案可视化</h3>
                <div class="card">
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="resultTabs">
                            <li class="nav-item">
                                <a class="nav-link nav-link1 active" data-bs-toggle="tab" href="#visual">可视化视图</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link nav-link1" data-bs-toggle="tab" href="#table">表格视图</a>
                            </li>
                        </ul>

                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="visual">
                                <div id="cuttingVisualization"></div>
                            </div>
                            <div class="tab-pane fade" id="table">
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <!-- 表格内容将通过JavaScript动态生成 -->
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 删除原来的统计信息区域 -->
    </div>
    <footer class="main-footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <h3>关于我们</h3>
            <p>专注于为门窗加工企业提供智能切割优化解决方案，助力企业降本增效，提升竞争力。</p>
          </div>
          <div class="footer-section">
            <h3>核心优势</h3>
            <ul>
              <li><i class="fas fa-check-circle"></i> 智能算法优化</li>
              <li><i class="fas fa-check-circle"></i> 材料利用最大化</li>
              <li><i class="fas fa-check-circle"></i> 操作简单直观</li>
              <li><i class="fas fa-check-circle"></i> 效率显著提升</li>
            </ul>
          </div>
          <div class="footer-section">
            <h3>系统功能</h3>
            <ul>
              <li><a href="plasticsteelcutting.html">门窗材料切割优化</a></li>
              <li><a href="materialusage.html">玻璃切割优化系统</a></li>
              <li><a href="#">批量优化计算</a></li>
              <li><a href="#">数据统计分析</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h3>联系方式</h3>
            <ul>
              <li><i class="fas fa-phone"></i> 服务热线：400-xxxx-xxxx</li>
              <li><i class="fas fa-envelope"></i> 邮箱：support@example.com</li>
              <li><i class="fas fa-clock"></i> 工作时间：周一至周五 9:00-18:00</li>
            </ul>
          </div>
        </div>
        <div class="footer-bottom">
          <p>© 2024 新睿科技 - 智能切割优化系统 - 让每一次切割都物尽其用</p>
        </div>
      </div>
    </footer>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // 核心算法和数据处理类
      class CuttingOptimizer {
        constructor() {
          this.materials = [];
          this.cuttingList = [];
          this.results = [];
          this.scrapPieces = []; // 存储可重用的边角料
          this.cuttingGap = 1; // 切割余量(mm)
          this.minScrapSize = 50; // 最小可重用边角料尺寸(mm)
          // 添加配置参数
          this.config = {
            cuttingGap: 1,
            minScrapSize: 50,
            weights: {
                area: 0.4,
                alignment: 0.3,
                waste: 0.3
            }
          };
        }

        // 添加原材料
        addMaterial(length, width) {
          if (length <= 0 || width <= 0) {
            throw new Error('材料尺寸必须大于0');
          }
          this.materials.push({ length, width, area: length * width });
        }

        // 添加切割项
        addCuttingItem(length, width, quantity) {
          if (length <= 0 || width <= 0 || quantity <= 0) {
            throw new Error('切割项参数必须大于0');
          }
          this.cuttingList.push({ length, width, quantity, area: length * width });
        }

        // 改进的优化算法
        optimize() {
          this.results = [];
          this.scrapPieces = [];
          
          // 对切割清单按面积降序排序
          const sortedPieces = this._sortCuttingList();
          let remainingPieces = [...sortedPieces];
      
          while (remainingPieces.some(piece => piece.quantity > 0)) {
            // 先尝试使用边角料
            const scrapResult = this._tryUseScrap(remainingPieces);
            if (scrapResult.success) {
              this.results.push(scrapResult.result);
              continue;
            }
      
            // 使用新材料
            const result = this._cutNewMaterial(remainingPieces);
            if (result) {
              this.results.push(result);
            } else {
              throw new Error('无法完成切割任务，请检查材料尺寸');
            }
          }
      
          return this.results;
        }

        _sortCuttingList() {
          return this.cuttingList.map(piece => ({
            ...piece,
            score: this._calculatePieceValue(piece)
          })).sort((a, b) => b.score - a.score);
        }
      
        _calculatePieceValue(piece) {
          // 考虑多个因素的权重评分
          const area = piece.length * piece.width;
          const perimeter = 2 * (piece.length + piece.width);
          const aspectRatio = Math.max(piece.length / piece.width, piece.width / piece.length);
          
          return (
            area * 0.5 + // 面积权重
            perimeter * 0.2 + // 周长权重
            (1 / aspectRatio) * 0.3 // 形状权重
          );
        }
      
        _tryUseScrap(pieces) {
          for (let i = 0; i < this.scrapPieces.length; i++) {
            const scrap = this.scrapPieces[i];
            
            // 验证边角料数据
            if (!scrap || !scrap.length || !scrap.width) {
              continue;
            }
      
            const result = this._optimizeSingleSheet(
              scrap.length - this.config.cuttingGap,
              scrap.width - this.config.cuttingGap,
              pieces,
              [],
              0,
              0
            );
      
            if (result && result.cuts && result.cuts.length > 0) {
              this.scrapPieces.splice(i, 1);
              
              // 更新面积计算
              result.originalSize = { ...scrap };
              result.usedArea = result.cuts.reduce((sum, cut) => sum + (cut.length * cut.width), 0);
              result.utilization = (result.usedArea / scrap.area) * 100;
              result.waste = scrap.area - result.usedArea;
              result.wasteRate = (result.waste / scrap.area) * 100;

              return {
                success: true,
                result: {
                  ...result,
                  isScrap: true
                }
              };
            }
          }
      
          return { success: false };
        }
      
        _cutNewMaterial(pieces) {
          if (this.materials.length === 0) return null;
      
          const material = this.materials[0];
          
          // 确保材料对象包含所有必要属性
          if (!material || !material.length || !material.width) {
            throw new Error('无效的材料尺寸');
          }
      
          const result = this._optimizeSingleSheet(
            material.length - this.config.cuttingGap, // 使用配置的切割余量
            material.width - this.config.cuttingGap,
            pieces,
            [],
            0,
            0
          );
      
          // 更新原始尺寸信息和面积计算
          result.originalSize = { ...material };
          result.usedArea = result.cuts.reduce((sum, cut) => sum + (cut.length * cut.width), 0);
          result.utilization = (result.usedArea / material.area) * 100;
          result.waste = material.area - result.usedArea;
          result.wasteRate = (result.waste / material.area) * 100;
      
          this._handleScraps(result);
      
          return result;
        }
      
        _handleScraps(result) {
          // 确保result对象存在且包含必要属性
          if (!result || !result.cuts || !result.originalSize) {
            return;
          }
      
          const usedAreas = new Set();
          result.cuts.forEach(cut => {
            if (cut && typeof cut.x === 'number' && typeof cut.y === 'number' &&
                typeof cut.length === 'number' && typeof cut.width === 'number') {
              const area = {
                x1: cut.x,
                y1: cut.y,
                x2: cut.x + cut.length,
                y2: cut.y + cut.width
              };
              usedAreas.add(area);
            }
          });
      
          // 识别可用边角料
          const scraps = this._identifyScraps(usedAreas, result.originalSize);
          scraps.forEach(scrap => {
            if (scrap.length >= this.config.minScrapSize && 
                scrap.width >= this.config.minScrapSize) {
              this.scrapPieces.push(scrap);
            }
          });
        }
      
        _identifyScraps(usedAreas, originalSize) {
          // 复杂的边角料识别算法
          const scraps = [];
          let currentY = 0;
      
          while (currentY < originalSize.width) {
            let currentX = 0;
            while (currentX < originalSize.length) {
              const scrap = this._findLargestFreeRectangle(
                currentX,
                currentY,
                usedAreas,
                originalSize
              );
              
              if (scrap) {
                scraps.push(scrap);
                currentX = scrap.x + scrap.length;
              } else {
                currentX++;
              }
            }
            currentY++;
          }
      
          return scraps;
        }
      
        _findLargestFreeRectangle(startX, startY, usedAreas, bounds) {
          // 查找最大空闲矩形
          let maxWidth = bounds.width - startY;
          let maxLength = bounds.length - startX;
      
          for (const used of usedAreas) {
            if (used.x1 <= startX && used.x2 > startX) {
              maxWidth = Math.min(maxWidth, used.y1 - startY);
            }
            if (used.y1 <= startY && used.y2 > startY) {
              maxLength = Math.min(maxLength, used.x1 - startX);
            }
          }
      
          if (maxWidth <= 0 || maxLength <= 0) return null;
      
          return {
            x: startX,
            y: startY,
            length: maxLength,
            width: maxWidth
          };
        }

        // 递归切割单张材料
        _optimizeSingleSheet(remainingLength, remainingWidth, pieces, cuts, startX, startY) {
          // 初始化返回对象，确保所有必要的属性都存在
          const result = {
            cuts: cuts || [],
            utilization: 0,
            waste: remainingLength * remainingWidth,
            usedArea: 0,  // 添加实际使用面积属性
            wasteRate: 0, // 添加废料率属性
            originalSize: {
              length: remainingLength,
              width: remainingWidth,
              area: remainingLength * remainingWidth
            }
          };
      
          // 添加输入验证
          if (!remainingLength || !remainingWidth || remainingLength <= 0 || remainingWidth <= 0) {
            return result;
          }
      
          // 如果剩余空间太小,直接返回当前结果
          if (remainingLength < this.MIN_SIZE || remainingWidth < this.MIN_SIZE) {
            return result;
          }
      
          // 检查是否与现有切割重叠
          const hasOverlap = (x, y, length, width) => {
            return result.cuts.some(cut => {
              return !(x >= cut.x + cut.length || // 在右边
                cut.x >= x + length || // 在左边
                y >= cut.y + cut.width || // 在下边
                cut.y >= y + width); // 在上边
            });
          };
      
          // 找到最适合的切割片
          let bestPiece = null;
          let bestScore = -1;
          let bestRotation = false;
      
          for (let piece of pieces) {
            if (piece.quantity <= 0) continue;
      
            // 检查两种放置方向
            const orientations = [
              { length: piece.length, width: piece.width, rotated: false },
              { length: piece.width, width: piece.length, rotated: true }
            ];
      
            for (const orientation of orientations) {
              if (orientation.length > remainingLength ||
                orientation.width > remainingWidth) continue;
      
              // 检查是否会造成重叠
              if (hasOverlap(startX, startY, orientation.length, orientation.width)) continue;
      
              // 计算适应度分数
              const score = this._calculateFitScore(
                orientation.length,
                orientation.width,
                remainingLength,
                remainingWidth
              );
      
              if (score > bestScore) {
                bestScore = score;
                bestPiece = piece;
                bestRotation = orientation.rotated;
              }
            }
          }
      
          if (bestPiece) {
            const finalLength = bestRotation ? bestPiece.width : bestPiece.length;
            const finalWidth = bestRotation ? bestPiece.length : bestPiece.width;
      
            // 添加切割
            result.cuts.push({
              x: startX,
              y: startY,
              length: finalLength,
              width: finalWidth,
              rotated: bestRotation,
              originalPiece: { ...bestPiece }
            });
      
            // 更新剩余数量
            const pieceIndex = pieces.findIndex(p =>
              p.length === bestPiece.length &&
              p.width === bestPiece.width
            );
            pieces[pieceIndex].quantity--;
      
            // 计算新的利用率和废料
            const usedArea = result.cuts.reduce((sum, cut) => sum + (cut.length * cut.width), 0);
            const totalArea = result.originalSize.area;
            result.utilization = (usedArea / totalArea) * 100;
            result.waste = totalArea - usedArea;
            result.wasteRate = (result.waste / totalArea) * 100;
      
            // 分割剩余空间为两个矩形区域
            // 水平方向剩余空间
            const horizontalResult = this._optimizeSingleSheet(
              remainingLength - finalLength,
              finalWidth,
              pieces,
              result.cuts,
              startX + finalLength,
              startY
            );
      
            // 垂直方向剩余空间
            const verticalResult = this._optimizeSingleSheet(
              remainingLength,
              remainingWidth - finalWidth,
              pieces,
              result.cuts,
              startX,
              startY + finalWidth
            );
      
            // 合并所有切割结果
            result.cuts = [...new Set([...result.cuts, ...horizontalResult.cuts, ...verticalResult.cuts])];
          }
      
          return result;
        }

        _calculateFitScore(pieceLength, pieceWidth, remainingLength, remainingWidth) {
          // 改进评分系统
          const areaUtilization = (pieceLength * pieceWidth) / (remainingLength * remainingWidth);
          const edgeAlignment = Math.min(
            pieceLength / remainingLength,
            pieceWidth / remainingWidth
          );
          const wasteMinimization = 1 - (
            (remainingLength - pieceLength) * (remainingWidth - pieceWidth) /
            (remainingLength * remainingWidth)
          );
          
          return (
            areaUtilization * this.config.weights.area + // 使用配置参数
            edgeAlignment * this.config.weights.alignment + // 使用配置参数
            wasteMinimization * this.config.weights.waste // 使用配置参数
          );
        }

        // 添加边界检查
        _validateDimensions(length, width) {
          if (length <= 0 || width <= 0) {
            throw new Error('尺寸必须大于0');
          }
          if (!Number.isFinite(length) || !Number.isFinite(width)) {
            throw new Error('尺寸必须是有效数字');
          }
        }

        // 添加最小尺寸限制
        MIN_SIZE = 10; // 最小切割尺寸(mm)

        // 获取统计数据
        getStatistics() {
          const results = this.results.map(result => {
            const totalArea = result.originalSize.area;
            const usedArea = result.cuts.reduce((sum, cut) => sum + (cut.length * cut.width), 0);
            return {
              totalArea,
              usedArea,
              waste: totalArea - usedArea
            };
          });

          const totalMaterialArea = results.reduce((sum, r) => sum + r.totalArea, 0);
          const totalUsedArea = results.reduce((sum, r) => sum + r.usedArea, 0);

          return {
            totalMaterials: this.results.length,
            totalMaterialArea,
            totalUsedArea,
            averageUtilization: (totalUsedArea / totalMaterialArea) * 100,
            totalWaste: totalMaterialArea - totalUsedArea,
            wastePercentage: ((totalMaterialArea - totalUsedArea) / totalMaterialArea) * 100
          };
        }
      }

      // UI 控制器类
      class UIController {
        constructor() {
          this.optimizer = new CuttingOptimizer();
          this.initializeEventListeners();
        }

        initializeEventListeners() {
          // 添加原材料按钮
          document.getElementById('addMaterial').addEventListener('click', () => {
            this.addMaterialInput();
          });

          // 添加切割项按钮
          document.getElementById('addCuttingItem').addEventListener('click', () => {
            this.addCuttingItemInput();
          });

          // 计算按钮
          document.getElementById('calculateBtn').addEventListener('click', () => {
            this.calculateOptimization();
          });

          // 初始化删除按钮事件
          this.initializeDeleteButtons();

          // 参数设置相关事件
          document.getElementById('cuttingGap').addEventListener('change', (e) => {
            this.optimizer.config.cuttingGap = parseFloat(e.target.value);
          });

          document.getElementById('minScrapSize').addEventListener('change', (e) => {
            this.optimizer.config.minScrapSize = parseFloat(e.target.value);
          });

          document.getElementById('areaWeight').addEventListener('change', (e) => {
            this.optimizer.config.weights.area = parseFloat(e.target.value);
            this.validateWeights();
          });

          document.getElementById('alignmentWeight').addEventListener('change', (e) => {
            this.optimizer.config.weights.alignment = parseFloat(e.target.value);
            this.validateWeights();
          });

          document.getElementById('wasteWeight').addEventListener('change', (e) => {
            this.optimizer.config.weights.waste = parseFloat(e.target.value);
            this.validateWeights();
          });

          document.getElementById('resetParams').addEventListener('click', () => {
            this.resetParameters();
          });
        }

        addMaterialInput() {
          const materialList = document.getElementById('materialList');
          const materialItem = document.createElement('div');
          materialItem.className = 'material-item';
          materialItem.innerHTML = `
                <div class="input-group mb-2">
                    <input type="number" class="form-control" placeholder="长度(mm)">
                    <input type="number" class="form-control" placeholder="宽度(mm)">
                    <button class="btn btn-outline-danger btn-icon delete-material">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `;
          materialList.appendChild(materialItem);
          this.initializeDeleteButtons();
        }

        addCuttingItemInput() {
          const cuttingList = document.getElementById('cuttingList');
          const cuttingItem = document.createElement('div');
          cuttingItem.className = 'cutting-list-item';
          cuttingItem.innerHTML = `
                <input type="number" class="form-control" placeholder="长度(mm)">
                <input type="number" class="form-control" placeholder="宽度(mm)">
                <input type="number" class="form-control" placeholder="数量">
                <button class="btn btn-outline-danger btn-icon delete-cutting">
                    <i class="fas fa-trash-alt"></i>
                </button>
            `;
          cuttingList.appendChild(cuttingItem);
          this.initializeDeleteButtons();
        }

        initializeDeleteButtons() {
          document.querySelectorAll('.delete-material').forEach(button => {
            button.onclick = (e) => {
              e.target.closest('.material-item').remove();
            };
          });

          document.querySelectorAll('.delete-cutting').forEach(button => {
            button.onclick = (e) => {
              e.target.closest('.cutting-list-item').remove();
            };
          });
        }

        calculateOptimization() {
          try {
            this.optimizer = new CuttingOptimizer();

            // 收集原材料数据
            document.querySelectorAll('.material-item').forEach(item => {
              const inputs = item.querySelectorAll('input');
              const length = parseFloat(inputs[0].value);
              const width = parseFloat(inputs[1].value);
              if (length && width) {
                this.optimizer.addMaterial(length, width);
              }
            });

            // 收集切割清单数据
            document.querySelectorAll('.cutting-list-item').forEach(item => {
              const inputs = item.querySelectorAll('input');
              const length = parseFloat(inputs[0].value);
              const width = parseFloat(inputs[1].value);
              const quantity = parseInt(inputs[2].value);
              if (length && width && quantity) {
                this.optimizer.addCuttingItem(length, width, quantity);
              }
            });

            // 执行优化
            const results = this.optimizer.optimize();
            const statistics = this.optimizer.getStatistics();

            // 更新统计信息
            this.updateStatistics(statistics);

            // 更新可视化
            this.updateVisualization(results);

            // 更新表格视图
            this.updateTableView(results);

          } catch (error) {
            alert('计算过程中发生错误: ' + error.message);
          }
        }

        updateStatistics(statistics) {
          document.getElementById('utilizationRate').textContent =
            statistics.averageUtilization.toFixed(2) + '%';
          document.getElementById('wasteRate').textContent =
            statistics.wastePercentage.toFixed(2) + '%';
          document.getElementById('materialUsage').textContent =
            statistics.totalMaterials + '张';
          document.getElementById('costSaving').textContent =
            '预计节省' + (statistics.averageUtilization - 70).toFixed(2) + '%';
        }

        updateVisualization(results) {
          const visualizationArea = document.getElementById('cuttingVisualization');
          visualizationArea.innerHTML = '';

          results.forEach((result, index) => {
            const canvas = document.createElement('canvas');
            canvas.className = 'cutting-canvas';
            canvas.width = 600;
            canvas.height = 600;
            visualizationArea.appendChild(canvas);

            const ctx = canvas.getContext('2d');
            this.drawCuttingPlan(ctx, result, canvas.width, canvas.height);
          });
        }

        drawCuttingPlan(ctx, result, canvasWidth, canvasHeight) {
          // 创建容器
          const container = document.createElement('div');
          container.className = 'cutting-plan-container mb-4';
        
          // 添加详细信息面板
          const infoPanel = document.createElement('div');
          infoPanel.className = 'card mb-2';
          infoPanel.innerHTML = `
            <div class="card-body">
              <h5 class="card-title">原材料 ${this.optimizer.results.indexOf(result) + 1} 切割方案</h5>
              <div class="row">
                <div class="col-md-4">
                  <strong>原材料尺寸：</strong> ${result.originalSize.length}×${result.originalSize.width}mm
                  <br>
                  <strong>材料面积：</strong> ${result.originalSize.area}mm²
                </div>
                <div class="col-md-4">
                  <strong>实际使用面积：</strong> ${result.usedArea.toFixed(2)}mm²
                  <br>
                  <strong>实际利用率：</strong> ${result.utilization.toFixed(2)}%
                </div>
                <div class="col-md-4">
                  <strong>废料面积：</strong> ${result.waste.toFixed(2)}mm²
                  <br>
                  <strong>废料率：</strong> ${result.wasteRate.toFixed(2)}%
                </div>
              </div>
              
              <div class="mt-3">
                <h6>切割清单明细：</h6>
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>序号</th>
                        <th>尺寸(长×宽)</th>
                        <th>面积</th>
                        <th>位置(X,Y)</th>
                        <th>旋转</th>
                        <th>占比</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${result.cuts.map((cut, index) => `
                        <tr>
                          <td>${index + 1}</td>
                          <td>${cut.length}×${cut.width}mm</td>
                          <td>${(cut.length * cut.width).toFixed(2)}mm²</td>
                          <td>(${cut.x}, ${cut.y})</td>
                          <td>${cut.rotated ? '是' : '否'}</td>
                          <td>${((cut.length * cut.width) / result.originalSize.area * 100).toFixed(2)}%</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          `;
          container.appendChild(infoPanel);
        
          document.getElementById('cuttingVisualization').appendChild(container);
        
          // 清空画布
          ctx.clearRect(0, 0, canvasWidth, canvasHeight);
        
          // 计算缩放比例
          const scaleX = (canvasWidth - 20) / result.originalSize.length;
          const scaleY = (canvasHeight - 20) / result.originalSize.width;
          const scale = Math.min(scaleX, scaleY);
        
          // 绘制原材料边框
          ctx.strokeStyle = '#000';
          ctx.lineWidth = 2;
          ctx.strokeRect(10, 10, result.originalSize.length * scale, result.originalSize.width * scale);
        
          // 使用不同颜色绘制切割块
          const colors = [
            '#FFB6C1', '#98FB98', '#87CEFA', '#DDA0DD', '#F0E68C',
            '#E6E6FA', '#FFE4B5', '#B8860B', '#20B2AA', '#FF69B4'
          ];
        
          // 绘制切割线和填充区域
          result.cuts.forEach((cut, index) => {
            const x = cut.x * scale + 10;
            const y = cut.y * scale + 10;
            const width = cut.length * scale;
            const height = cut.width * scale;
        
            // 填充颜色
            ctx.fillStyle = colors[index % colors.length];
            ctx.fillRect(x, y, width, height);
        
            // 绘制边框
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 1;
            ctx.strokeRect(x, y, width, height);
        
            // 添加尺寸标注
            ctx.fillStyle = '#000';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            
            // 绘制编号和尺寸
            const text = `#${index + 1}`;
            const dims = `${cut.length}×${cut.width}`;
            
            ctx.fillText(text, x + width/2, y + height/2 - 6);
            ctx.fillText(dims, x + width/2, y + height/2 + 6);
          });
        }

        updateTableView(results) {
          const tableBody = document.querySelector('#table table');
          let html = `
            <thead>
              <tr>
                <th>材料编号</th>
                <th>原始尺寸</th>
                <th>切割明细</th>
                <th>利用率</th>
                <th>废料分析</th>
              </tr>
            </thead>
            <tbody>
          `;

          results.forEach((result, index) => {
            // 统计相同尺寸的切割件数量
            const cutSummary = result.cuts.reduce((acc, cut) => {
              const key = `${cut.length}×${cut.width}`;
              acc[key] = (acc[key] || 0) + 1;
              return acc;
            }, {});

            html += `
              <tr>
                <td>${index + 1}</td>
                <td>
                  ${result.originalSize.length}×${result.originalSize.width}mm
                  <br>
                  <small class="text-muted">面积: ${result.originalSize.area}mm²</small>
                </td>
                <td>
                  <strong>总数量: ${result.cuts.length}块</strong>
                  <br>
                  <strong>使用面积: ${result.usedArea.toFixed(2)}mm²</strong>
                  <br>
                  ${Object.entries(cutSummary).map(([size, count]) => 
                    `<small>${size}mm: ${count}块</small>`
                  ).join('<br>')}
                </td>
                <td>
                  利用率: ${result.utilization.toFixed(2)}%
                  <br>
                  <div class="progress" style="height: 5px;">
                    <div class="progress-bar bg-success" style="width: ${result.utilization}%"></div>
                  </div>
                </td>
                <td>
                  废料面积: ${result.waste.toFixed(2)}mm²
                  <br>
                  废料率: ${result.wasteRate.toFixed(2)}%
                  <br>
                  <small class="text-muted">可重用边角料: ${
                    result.scraps ? result.scraps.length : 0
                  }块</small>
                </td>
              </tr>
            `;
          });

          html += '</tbody>';
          tableBody.innerHTML = html;
        }

        validateWeights() {
          const weights = this.optimizer.config.weights;
          const sum = weights.area + weights.alignment + weights.waste;
          if (Math.abs(sum - 1) > 0.01) {
              alert('警告：权重之和应该等于1，请调整参数');
          }
        }

        resetParameters() {
          this.optimizer.config = {
              cuttingGap: 1,
              minScrapSize: 50,
              weights: {
                  area: 0.4,
                  alignment: 0.3,
                  waste: 0.3
              }
          };
          
          // 更新UI显示
          document.getElementById('cuttingGap').value = this.optimizer.config.cuttingGap;
          document.getElementById('minScrapSize').value = this.optimizer.config.minScrapSize;
          document.getElementById('areaWeight').value = this.optimizer.config.weights.area;
          document.getElementById('alignmentWeight').value = this.optimizer.config.weights.alignment;
          document.getElementById('wasteWeight').value = this.optimizer.config.weights.waste;
        }
      }

      // 初始化应用
      document.addEventListener('DOMContentLoaded', () => {
        const app = new UIController();
      });
    </script>
</body>
</html>