<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能门窗材料切割切割优化系统</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- SheetJS (Excel导出) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- html2pdf (PDF导出) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- html2canvas (图片导出) -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* 通用头部样式 */
.main-header {
    background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.brand-area {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.brand-logo {
    font-size: 2rem;
    color: white;
}

.brand-text h1 {
    font-size: 1.5rem;
    margin: 0;
}

.brand-slogan {
    font-size: 0.9rem;
    opacity: 0.9;
}

.nav-area {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
}

.nav-link {
    color: white;
    text-decoration: none;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
}

.nav-link:hover {
    background: rgba(255,255,255,0.1);
    color: white;
}

.nav-link.active {
    background: rgba(255,255,255,0.2);
}

/* 页面副标题区域 */
.page-subtitle {
    text-align: center;
    margin-bottom: 3rem;
    padding: 2rem;
    background: #f8f9fa;
    border-radius: 10px;
}

.page-subtitle h2 {
    color: #2c3e50;
    margin-bottom: 1rem;
}

.page-subtitle p {
    color: #666;
    max-width: 800px;
    margin: 0 auto;
}

/* 统一的页脚样式 */
.main-footer {
    background: #2c3e50;
    color: white;
    padding: 3rem 0 2rem;
    margin-top: 4rem;
}

.footer-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
}

.footer-section h3 {
    font-size: 1.2rem;
    margin-bottom: 1rem;
    color: #3498db;
}

.footer-section ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.footer-section ul li {
    margin-bottom: 0.5rem;
}

.footer-section a {
    color: rgba(255,255,255,0.8);
    text-decoration: none;
    transition: color 0.3s ease;
}

.footer-section a:hover {
    color: white;
}

.footer-bottom {
    text-align: center;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid rgba(255,255,255,0.1);
}

/* 响应式调整 */
@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        text-align: center;
        gap: 1.5rem;
        padding: 1rem 0;
    }

    .nav-area {
        width: 100%;
        justify-content: center;
        gap: 0.5rem;
        flex-direction: column;
        padding: 0 1rem;
    }

    .nav-link {
        justify-content: center;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .nav-link:active {
        transform: scale(0.95);
    }

    .nav-link i {
        font-size: 1rem;
    }

    .brand-area {
        width: 100%;
        justify-content: center;
    }

    .brand-text h1 {
        font-size: 1.25rem;
    }

    .brand-slogan {
        font-size: 0.8rem;
    }

    .footer-content {
        grid-template-columns: 1fr;
        text-align: center;
    }
}

/* 适配超小屏幕 */
@media (max-width: 360px) {
    .nav-area {
        padding: 0 0.5rem;
    }

    .nav-link {
        padding: 0.5rem;
        font-size: 0.8rem;
    }

    .brand-text h1 {
        font-size: 1.1rem;
    }
}

    </style>
    <style>
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
            padding-bottom: 50px;
        }
        .container {
            max-width: 1000px;
            padding: 2rem;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .btn-primary {
            background-color: #4361ee;
            border: none;
            padding: 0.8rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #3046c5;
            transform: scale(1.05);
        }
        .btn-add {
            background-color: #2ecc71;
            color: white;
            border: none;
            transition: all 0.3s ease;
        }
        .btn-add:hover {
            background-color: #27ae60;
            transform: scale(1.05);
        }
        .btn-remove {
            background-color: #e74c3c;
            color: white;
            border: none;
            transition: all 0.3s ease;
            width: 32px;
            height: 32px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn-remove:hover {
            background-color: #c0392b;
            transform: scale(1.05);
        }
        .result-area {
            display: none;
            margin-top: 2rem;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 2rem 0;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .form-control:focus {
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
            border-color: #4361ee;
        }
        .alert {
            border-radius: 10px;
        }
        .cutting-plan {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .cutting-plan h4 {
            color: #4361ee;
            margin-bottom: 1rem;
        }
        .progress {
            height: 2rem;
            margin: 1rem 0;
        }
        .cut-piece {
            background-color: #4361ee;
        }
        .waste-piece {
            background-color: #dc3545;
        }
        .cut-loss-piece {
            background-color: #ffc107;
        }
        .input-row {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .input-row:hover {
            background-color: #f8f9fa;
        }
        .input-row .row {
            margin: 0;
            --bs-gutter-x: 0.75rem;
        }
        .stock-length-item {
            display: inline-flex;
            align-items: center;
            margin: 5px;
            padding: 8px 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .stock-length-item .btn-remove {
            width: 24px;
            height: 24px;
            margin-left: 8px;
            font-size: 12px;
        }
        .col-length {
            flex: 0 0 auto;
            width: 45%;
            padding: 0 0.5rem;
        }
        .col-quantity {
            flex: 0 0 auto;
            width: 35%;
            padding: 0 0.5rem;
        }
        .col-action {
            flex: 0 0 auto;
            width: 20%;
            padding: 0 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .is-invalid {
            border-color: #dc3545;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        .invalid-feedback {
            display: block;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: #dc3545;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-content {
            text-align: center;
            background-color: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        .loading-content.show {
            transform: translateY(0);
            opacity: 1;
        }
        .loading .spinner-border {
            width: 3rem;
            height: 3rem;
            color: #4361ee;
        }
        .loading-text {
            margin-top: 1rem;
            color: #4361ee;
            font-weight: 500;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }
        .toast {
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .toast.show {
            opacity: 1;
        }
        .toast .spinner-border {
            width: 1rem;
            height: 1rem;
            border-width: 0.15em;
        }
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.65;
        }
        .page-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9998;
            backdrop-filter: blur(4px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .page-overlay.show {
            opacity: 1;
        }
        .calculating-content {
            background: rgba(255, 255, 255, 0.95);
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 90%;
            width: 400px;
        }
        .calculating-content.show {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .calculating-spinner {
            width: 60px;
            height: 60px;
            border-width: 3px;
            color: #4361ee;
            margin-bottom: 1.5rem;
        }
        .calculating-title {
            color: #2d3748;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .calculating-text {
            color: #4a5568;
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 0.5rem;
        }
        .calculating-progress {
            color: #718096;
            font-size: 0.875rem;
            margin-top: 1rem;
        }
        .calculating-tips {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            color: #718096;
            font-size: 0.875rem;
            font-style: italic;
        }
        .calculating {
            cursor: wait !important;
        }
        .calculating * {
            cursor: wait !important;
        }
        .result-tabs {
            margin-bottom: 1.5rem;
        }
        .result-tabs .nav-link {
            color: #4a5568;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border: none;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .result-tabs .nav-link:hover {
            color: #4361ee;
        }
        .result-tabs .nav-link.active {
            color: #4361ee;
            border-bottom-color: #4361ee;
            background: none;
        }
        .result-table {
            width: 100%;
            margin-bottom: 1.5rem;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .result-table th {
            background-color: #f8f9fa;
            color: #2d3748;
            font-weight: 600;
            padding: 1rem;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
        }
        .result-table td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
        }
        .result-table tbody tr:hover {
            background-color: #f8fafc;
        }
        .result-table .text-end {
            text-align: right;
        }
        .utilization-cell {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .utilization-bar {
            flex-grow: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }
        .utilization-progress {
            height: 100%;
            background: #4361ee;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .summary-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .summary-table th {
            width: 40%;
            background-color: #f8f9fa;
            padding: 0.75rem 1rem;
            color: #2d3748;
            font-weight: 600;
            border-bottom: 1px solid #e2e8f0;
        }
        .summary-table td {
            padding: 0.75rem 1rem;
            color: #4a5568;
            border-bottom: 1px solid #e2e8f0;
        }
        .tab-content {
            padding-top: 1.5rem;
        }
        .badge-stock {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background-color: #e2e8f0;
            color: #4a5568;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .cuts-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 0;
            padding: 0;
            list-style: none;
        }
        .cuts-list li {
            background-color: #f1f5f9;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            color: #4a5568;
        }
        /* 添加图片导出相关样式 */
        .btn-outline-info {
            color: #0dcaf0;
            border-color: #0dcaf0;
        }
        .btn-outline-info:hover {
            color: #fff;
            background-color: #0dcaf0;
            border-color: #0dcaf0;
        }
        @media print {
            .result-area .card {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            .cutting-plan {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            .table-responsive {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
        
        /* 添加移动端样式优化 */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            /* 优化结果区域的按钮组布局 */
            .alert-success {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }
            
            .alert-success .float-end {
                float: none !important;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                width: 100%;
            }
            
            .alert-success .btn-group {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
                width: 100%;
            }
            
            .alert-success .btn {
                width: 100%;
                margin: 0 !important;
                padding: 0.5rem;
                display: flex;
                align-items: center;
                justify-content: center;
                white-space: nowrap;
            }

            /* 优化表格显示 */
            .table-responsive {
                margin-bottom: 1.5rem;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            
            .result-table th,
            .result-table td {
                padding: 0.75rem;
                font-size: 0.875rem;
            }
            
            .cuts-list {
                max-width: 200px;
                margin: 0;
            }
            
            .cuts-list li {
                margin-bottom: 0.25rem;
                font-size: 0.75rem;
            }
            
            /* 优化标签页导航 */
            .result-tabs {
                display: flex;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -1rem;
                padding: 0 1rem;
            }
            
            .result-tabs .nav-link {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
                white-space: nowrap;
            }
            
            /* 优化统计卡片 */
            .alert-primary,
            .alert-info {
                padding: 1rem;
                margin-bottom: 1rem;
                font-size: 0.875rem;
            }
            
            .alert-heading {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }
            
            /* 优化进度条显示 */
            .progress {
                height: 1.5rem;
            }
            
            .utilization-cell {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .utilization-bar {
                width: 100%;
                margin-bottom: 0.25rem;
            }
            
            /* 优化切割方案卡片 */
            .cutting-plan {
                padding: 0.75rem;
                margin-bottom: 1rem;
            }
            
            .cutting-plan h4 {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }
            
            /* 优化表单布局 */
            .input-row .row {
                margin: 0 -0.25rem;
            }
            
            .input-row .col-length,
            .input-row .col-quantity,
            .input-row .col-action {
                padding: 0 0.25rem;
            }
            
            .stock-length-item {
                font-size: 0.8125rem;
                padding: 0.375rem 0.75rem;
            }
        }
        
        /* 添加暗色模式支持 */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a202c;
                color: #e2e8f0;
            }
            
            .card {
                background-color: #2d3748;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            }
            
            .form-control {
                background-color: #2d3748;
                border-color: #4a5568;
                color: #e2e8f0;
            }
            
            .form-control:focus {
                background-color: #2d3748;
                border-color: #4361ee;
                color: #e2e8f0;
            }
            
            .table-responsive {
                background-color: #2d3748;
            }
            
            .result-table th {
                background-color: #4a5568;
                color: #e2e8f0;
            }
            
            .result-table td {
                color: #e2e8f0;
                border-color: #4a5568;
            }
            
            .badge-stock {
                background-color: #4a5568;
                color: #e2e8f0;
            }
            
            .cuts-list li {
                background-color: #4a5568;
                color: #e2e8f0;
            }
            
            .alert-success {
                background-color: #2d3748;
                border-color: #4361ee;
                color: #e2e8f0;
            }
            
            .alert-primary,
            .alert-info {
                background-color: #2d3748;
                border-color: #4361ee;
                color: #e2e8f0;
            }

            .nav-tabs {
                border-color: #4a5568;
            }

            .nav-tabs .nav-link {
                color: #e2e8f0;
            }

            .nav-tabs .nav-link:hover {
                border-color: #4a5568;
                color: #4361ee;
            }

            .nav-tabs .nav-link.active {
                background-color: #2d3748;
                border-color: #4a5568 #4a5568 #2d3748;
                color: #4361ee;
            }

            .summary-table th,
            .summary-table td {
                border-color: #4a5568;
                color: #e2e8f0;
            }

            .summary-table th {
                background-color: #4a5568;
            }

            .toast {
                background-color: rgba(45, 55, 72, 0.95);
                color: #e2e8f0;
            }

            .calculating-content {
                background-color: #2d3748;
                color: #e2e8f0;
            }

            .calculating-title {
                color: #e2e8f0;
            }

            .calculating-text,
            .calculating-progress,
            .calculating-tips {
                color: #a0aec0;
            }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="brand-area">
                    <div class="brand-logo">
                        <i class="fas fa-cut"></i>
                    </div>
                    <div class="brand-text">
                        <h1>智能切割优化软件系统</h1>
                        <div class="brand-slogan">让切割更智能 · 为企业创造价值</div>
                    </div>
                </div>
                <nav class="nav-area">
                    <a href="index.html" class="nav-link">
                        <i class="fas fa-home"></i> 首页
                    </a>
                    <a href="plasticsteelcutting.html" class="nav-link">
                        <i class="fas fa-window-maximize"></i> 门窗切割优化
                    </a>
                    <a href="materialusage.html" class="nav-link">
                        <i class="fas fa-crop"></i> 玻璃切割优化
                    </a>
                </nav>
            </div>
        </div>
    </header>
    
    <div class="page-subtitle">
        <div class="container">
            <h2>专业切割优化解决方案</h2>
            <p>运用智能算法为企业降本增效，实现精准切割、降低损耗、提升效率</p>
        </div>
    </div>

    <div class="container">
        <h1 class="text-center mb-5">优化切割计算器</h1>
        
        <div class="card p-4">
            <form id="cutForm">
                <!-- 原材料长度输入区域 -->
                <div class="mb-4">
                    <label class="form-label">原材料长度列表 (mm)</label>
                    <div class="input-group mb-2">
                        <input type="number" class="form-control" id="newStockLength" 
                               placeholder="输入原材料长度" step="0.01" min="1">
                        <button type="button" class="btn btn-add" id="addStockLength">
                            <i class="fas fa-plus"></i> 添加
                        </button>
                    </div>
                    <div id="stockLengthList" class="mb-2"></div>
                </div>

                <!-- 切割需求输入表格 -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <label class="form-label mb-0">切割需求列表</label>
                        <button type="button" class="btn btn-add" id="addCutRow">
                            <i class="fas fa-plus"></i> 添加行
                        </button>
                    </div>
                    <div id="cutRequirements"></div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="cutWidth" class="form-label">切割损耗宽度 (mm)</label>
                        <input type="number" class="form-control" id="cutWidth" value="4" min="0" step="0.1">
                    </div>
                    <div class="col-md-6">
                        <label for="minWaste" class="form-label">最小可接受废料 (mm)</label>
                        <input type="number" class="form-control" id="minWaste" value="50" min="0" step="0.1">
                    </div>
                </div>
                
                <div class="text-center">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-calculator me-2"></i>计算优化方案
                    </button>
                </div>
            </form>
        </div>

        <div class="loading-overlay">
            <div class="loading-content">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">计算中...</span>
                </div>
                <div class="loading-text">正在计算最优方案，请稍候...</div>
            </div>
        </div>

        <div class="result-area">
            <div class="card p-4">
                <h3 class="mb-4">计算结果</h3>
                <div id="resultContent"></div>
            </div>
        </div>
    </div>
    <div class="toast-container"></div>
    <div class="page-overlay">
        <div class="calculating-content">
            <div class="spinner-border calculating-spinner" role="status">
                <span class="visually-hidden">计算中...</span>
            </div>
            <div class="calculating-title">正在计算最优方案</div>
            <div class="calculating-text">系统正在进行复杂的切割优化计算</div>
            <div class="calculating-progress">请耐心等待...</div>
            <div class="calculating-tips">提示：计算时间取决于切割需求的复杂度</div>
        </div>
    </div>
    <footer class="main-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>关于我们</h3>
                    <p>专注于为门窗加工企业提供智能切割优化解决方案，助力企业降本增效，提升竞争力。</p>
                </div>
                <div class="footer-section">
                    <h3>核心优势</h3>
                    <ul>
                        <li><i class="fas fa-check-circle"></i> 智能算法优化</li>
                        <li><i class="fas fa-check-circle"></i> 材料利用最大化</li>
                        <li><i class="fas fa-check-circle"></i> 操作简单直观</li>
                        <li><i class="fas fa-check-circle"></i> 效率显著提升</li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>系统功能</h3>
                    <ul>
                        <li><a href="plasticsteelcutting.html">门窗材料切割优化</a></li>
                        <li><a href="materialusage.html">玻璃切割优化系统</a></li>
                        <li><a href="#">批量优化计算</a></li>
                        <li><a href="#">数据统计分析</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>联系方式</h3>
                    <ul>
                        <li><i class="fas fa-phone"></i> 服务热线：400-xxxx-xxxx</li>
                        <li><i class="fas fa-envelope"></i> 邮箱：support@example.com</li>
                        <li><i class="fas fa-clock"></i> 工作时间：周一至周五 9:00-18:00</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>© 2024 新睿科技 - 智能切割优化系统 - 让每一次切割都物尽其用</p>
            </div>
        </div>
    </footer>


    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // CuttingOptimizer类定义
        class CuttingOptimizer {
            constructor(stockLengths, orders, options = {}) {
                this.options = {
                    cutWidth: options.cutWidth || 4,
                    minWaste: options.minWaste || 50,
                    maxIterations: options.maxIterations || 1000, // 减少最大迭代次数
                    precision: options.precision || 2,
                    epsilon: options.epsilon || 0.0001,
                    minUtilization: options.minUtilization || 0.7, // 降低初始最小利用率要求
                    maxCombinations: options.maxCombinations || 100, // 减少组合尝试次数
                    maxRetries: options.maxRetries || 3, // 减少最大重试次数
                    maxPiecesPerStock: options.maxPiecesPerStock || 20, // 新增：每根原材料最大切割件数
                };

                this.validateInputs(stockLengths, orders);
                
                // 预处理并缓存数据
                this.stockLengths = this.preprocessStockLengths(stockLengths);
                this.orders = this.preprocessOrders(orders);
                this.cuttingPlans = [];
                this.totalWaste = 0;
                this.usedStocks = new Map();
                this.bestUtilization = 0;
                this.retryCount = 0;
                
                // 缓存计算结果
                this.combinationCache = new Map();
            }

            preprocessStockLengths(stockLengths) {
                // 预处理并排序原材料长度，去除不必要的长度
                return Array.from(new Set(stockLengths))
                    .map(len => this.round(len))
                    .sort((a, b) => a - b)
                    .filter((len, index, arr) => {
                        if (index === 0) return true;
                        return (len - arr[index - 1]) > this.options.epsilon;
                    });
            }

            round(number) {
                const factor = Math.pow(10, this.options.precision);
                return Math.round(number * factor) / factor;
            }

            numberUtils = {
                equals: (a, b) => Math.abs(a - b) < this.options.epsilon,
                lessThan: (a, b) => (b - a) > this.options.epsilon,
                greaterThan: (a, b) => (a - b) > this.options.epsilon,
                lessOrEqual: (a, b) => this.numberUtils.lessThan(a, b) || this.numberUtils.equals(a, b),
                greaterOrEqual: (a, b) => this.numberUtils.greaterThan(a, b) || this.numberUtils.equals(a, b)
            }

            validateInputs(stockLengths, orders) {
                if (!Array.isArray(stockLengths) || stockLengths.length === 0) {
                    throw new Error('必须提供至少一种原材料长度');
                }

                stockLengths.forEach((length, index) => {
                    if (!Number.isFinite(length) || this.numberUtils.lessOrEqual(length, 0)) {
                        throw new Error(`原材料长度 #${index + 1} 必须是正数`);
                    }
                });

                if (!Array.isArray(orders) || orders.length === 0) {
                    throw new Error('订单必须是非空数组');
                }

                orders.forEach(([length, quantity], index) => {
                    if (!Number.isFinite(length) || this.numberUtils.lessOrEqual(length, 0)) {
                        throw new Error(`订单 #${index + 1} 的长度必须是正数`);
                    }
                    if (!Number.isInteger(quantity) || quantity <= 0) {
                        throw new Error(`订单 #${index + 1} 的数量必须是正整数`);
                    }
                    const decimalPlaces = (length.toString().split('.')[1] || '').length;
                    if (decimalPlaces > this.options.precision) {
                        throw new Error(`订单 #${index + 1} 的长度小数位数不能超过 ${this.options.precision} 位`);
                    }
                });
            }

            preprocessOrders(orders) {
                let expandedOrders = [];
                const maxStockLength = Math.max(...this.stockLengths);
                const effectiveStockLength = this.round(maxStockLength - this.options.cutWidth);

                // 验证并展开订单
                orders.forEach(([length, quantity], index) => {
                    const roundedLength = this.round(length);
                    if (this.numberUtils.greaterThan(roundedLength, effectiveStockLength)) {
                        throw new Error(
                            `切割长度 ${roundedLength}mm 超过最大有效原材料长度 ${effectiveStockLength}mm ` +
                            `(考虑切割损耗 ${this.options.cutWidth}mm)`
                        );
                    }
                    for (let i = 0; i < quantity; i++) {
                        expandedOrders.push({
                            length: roundedLength,
                            originalIndex: index
                        });
                    }
                });

                // 按长度降序排序，但保持相同长度的随机排序以增加组合可能性
                return expandedOrders.sort((a, b) => {
                    if (Math.abs(b.length - a.length) < this.options.epsilon) {
                        return Math.random() - 0.5;
                    }
                    return b.length - a.length;
                });
            }

            findOptimalCombination(stockLength, pieces, minUtilization = 0) {
                const cacheKey = `${stockLength}-${pieces.map(p => p.length).join(',')}-${minUtilization}`;
                if (this.combinationCache.has(cacheKey)) {
                    return this.combinationCache.get(cacheKey);
                }

                const factor = Math.pow(10, this.options.precision);
                const intStockLength = Math.floor(stockLength * factor);
                const intPieces = pieces.map(p => Math.floor(p.length * factor));

                // 快速检查：如果所有片段总长度（包括切割损耗）超过原材料长度，直接返回
                const totalLength = intPieces.reduce((sum, p) => sum + p, 0);
                const maxCuts = Math.min(pieces.length, this.options.maxPiecesPerStock);
                const minCutLoss = (maxCuts - 1) * Math.floor(this.options.cutWidth * factor);
                
                if (totalLength + minCutLoss > intStockLength) {
                    const result = { indices: [], utilization: 0, value: 0 };
                    this.combinationCache.set(cacheKey, result);
                    return result;
                }

                // 优化的动态规划数组初始化
                const dp = new Int32Array(intStockLength + 1).fill(-1);
                const used = new Array(intStockLength + 1).fill(null);
                dp[0] = 0;

                // 限制最大切割件数
                const maxPieces = Math.min(intPieces.length, this.options.maxPiecesPerStock);

                // 优化的动态规划过程
                for (let i = 0; i < maxPieces; i++) {
                    const piece = intPieces[i];
                    for (let j = intStockLength; j >= piece; j--) {
                        if (dp[j - piece] !== -1) {
                            const newValue = dp[j - piece] + piece;
                            const cutLoss = ((used[j - piece]?.length || 0) + 1) * 
                                Math.floor(this.options.cutWidth * factor);
                            
                            if (newValue + cutLoss <= intStockLength && 
                                (dp[j] === -1 || newValue > dp[j])) {
                                dp[j] = newValue;
                                used[j] = used[j - piece] ? [...used[j - piece], i] : [i];
                            }
                        }
                    }
                }

                // 优化查找最优解过程
                let bestIndices = [];
                let bestUtilization = 0;
                let bestValue = 0;

                // 只检查可能的最优解区间
                const minAcceptableLength = Math.floor(intStockLength * minUtilization);
                const maxPossibleLength = intStockLength;

                for (let i = maxPossibleLength; i >= minAcceptableLength; i--) {
                    if (dp[i] !== -1) {
                        const usedLength = dp[i];
                        const cutLoss = (used[i]?.length || 0) * Math.floor(this.options.cutWidth * factor);
                        const totalUsed = usedLength + cutLoss;
                        
                        if (totalUsed <= intStockLength) {
                            const utilization = usedLength / intStockLength;
                            if (utilization >= minUtilization) {
                                bestUtilization = utilization;
                                bestIndices = used[i] || [];
                                bestValue = usedLength;
                                break; // 找到第一个满足条件的解就退出
                            }
                        }
                    }
                }

                const result = {
                    indices: bestIndices,
                    utilization: bestUtilization,
                    value: bestValue / factor
                };

                this.combinationCache.set(cacheKey, result);
                return result;
            }

            findBestCombination(remainingPieces, stockLength) {
                // 快速检查：如果剩余片段太少，直接返回简单解
                if (remainingPieces.length <= 2) {
                    const result = this.findOptimalCombination(
                        stockLength,
                        remainingPieces,
                        0
                    );
                    return result.indices.length > 0 ? {
                        pieces: result.indices.map(idx => remainingPieces[idx]),
                        utilization: result.utilization,
                        value: result.value
                    } : null;
                }

                let bestCombination = null;
                let maxUtilization = 0;

                // 优化的组合策略
                const strategies = [
                    // 策略1：按长度降序
                    () => [...remainingPieces].sort((a, b) => b.length - a.length),
                    // 策略2：贪心策略 - 尽可能装填最大长度
                    () => {
                        const sorted = [...remainingPieces].sort((a, b) => b.length - a.length);
                        const result = [];
                        let currentLength = 0;
                        const maxLength = stockLength - this.options.cutWidth;
                        
                        for (const piece of sorted) {
                            if (currentLength + piece.length + this.options.cutWidth <= maxLength) {
                                result.push(piece);
                                currentLength += piece.length + this.options.cutWidth;
                            }
                        }
                        return result;
                    }
                ];

                // 减少策略尝试次数
                const maxTriesPerStrategy = Math.min(
                    this.options.maxCombinations / strategies.length,
                    Math.ceil(Math.sqrt(remainingPieces.length))
                );

                for (const strategy of strategies) {
                    for (let i = 0; i < maxTriesPerStrategy; i++) {
                        const pieces = strategy();
                        const result = this.findOptimalCombination(
                            stockLength,
                            pieces,
                            maxUtilization
                        );

                        if (result.utilization > maxUtilization) {
                            maxUtilization = result.utilization;
                            bestCombination = {
                                pieces: result.indices.map(idx => pieces[idx]),
                                utilization: result.utilization,
                                value: result.value
                            };

                            if (maxUtilization >= this.options.minUtilization) {
                                return bestCombination;
                            }
                        }
                    }
                }

                return bestCombination;
            }

            optimize() {
                let remainingPieces = [...this.orders];
                let iterations = 0;
                
                // 预处理：按原材料长度对订单进行分组
                const groupedOrders = new Map();
                this.stockLengths.forEach(stockLength => {
                    const effectiveLength = stockLength - this.options.cutWidth;
                    groupedOrders.set(stockLength, remainingPieces.filter(
                        piece => piece.length <= effectiveLength
                    ));
                });
                
                while (remainingPieces.length > 0 && iterations < this.options.maxIterations) {
                    let bestPlan = null;
                    let bestStockLength = null;
                    let maxUtilization = 0;

                    // 优化的原材料选择策略
                    for (const stockLength of this.stockLengths) {
                        const suitablePieces = groupedOrders.get(stockLength);
                        if (!suitablePieces || suitablePieces.length === 0) continue;

                        const effectiveLength = stockLength - this.options.cutWidth;
                        const combination = this.findBestCombination(suitablePieces, effectiveLength);

                        if (combination && combination.utilization > maxUtilization) {
                            bestPlan = combination.pieces;
                            bestStockLength = stockLength;
                            maxUtilization = combination.utilization;

                            if (maxUtilization >= this.options.minUtilization) {
                                break;
                            }
                        }
                    }

                    if (!bestPlan || bestPlan.length === 0) {
                        // 优化的单件切割处理
                        const minPiece = remainingPieces.reduce((a, b) => 
                            a.length < b.length ? a : b);
                        const suitableStock = this.findBestStock(minPiece.length);

                        if (!suitableStock) {
                            throw new Error(`无法找到合适的切割方案，最小切割长度 ${minPiece.length}mm 无法适配任何原材料`);
                        }

                        bestPlan = [minPiece];
                        bestStockLength = suitableStock;
                    }

                    // 更新计划和统计信息
                    this.updatePlanAndStats(bestPlan, bestStockLength);

                    // 更新剩余片段和分组
                    const usedPieces = new Set(bestPlan);
                    remainingPieces = remainingPieces.filter(piece => !usedPieces.has(piece));
                    
                    // 更新分组数据
                    for (const [stockLength, pieces] of groupedOrders) {
                        groupedOrders.set(stockLength, 
                            pieces.filter(piece => !usedPieces.has(piece))
                        );
                    }

                    iterations++;
                }

                if (iterations >= this.options.maxIterations) {
                    throw new Error('超过最大迭代次数，可能存在无法解决的切割方案');
                }

                return this.generateReport();
            }

            updatePlanAndStats(bestPlan, bestStockLength) {
                const actualWaste = this.round(bestStockLength - 
                    bestPlan.reduce((sum, piece) => sum + piece.length, 0) - 
                    (this.options.cutWidth * (bestPlan.length - 1)));

                const utilization = (bestStockLength - actualWaste) / bestStockLength;
                this.bestUtilization = Math.max(this.bestUtilization, utilization);

                this.cuttingPlans.push({
                    stockLength: bestStockLength,
                    cuts: bestPlan.map(p => p.length),
                    waste: actualWaste,
                    cutLoss: this.round(this.options.cutWidth * (bestPlan.length - 1)),
                    utilization: utilization
                });

                this.usedStocks.set(
                    bestStockLength, 
                    (this.usedStocks.get(bestStockLength) || 0) + 1
                );

                this.totalWaste += actualWaste;
            }

            findBestStock(requiredLength) {
                let bestStock = null;
                let bestUtilization = 0;

                for (const stockLength of this.stockLengths) {
                    if (stockLength >= requiredLength + this.options.minWaste) {
                        const utilization = requiredLength / stockLength;
                        if (utilization > bestUtilization) {
                            bestUtilization = utilization;
                            bestStock = stockLength;
                        }
                    }
                }

                return bestStock;
            }

            generateReport() {
                const totalCutLoss = this.cuttingPlans.reduce((sum, plan) => sum + plan.cutLoss, 0);
                const totalUsedStocks = Array.from(this.usedStocks.values()).reduce((a, b) => a + b, 0);
                
                return {
                    cuttingPlans: this.cuttingPlans.map((plan, index) => ({
                        stockNumber: index + 1,
                        stockLength: plan.stockLength,
                        cuts: plan.cuts,
                        waste: plan.waste,
                        cutLoss: plan.cutLoss,
                        utilizationRate: (
                            (plan.stockLength - plan.waste - plan.cutLoss) / 
                            plan.stockLength * 100
                        ).toFixed(2) + '%'
                    })),
                    summary: {
                        stockUsage: Array.from(this.usedStocks.entries()).map(([length, count]) => ({
                            length: length,
                            count: count
                        })),
                        totalStocksUsed: totalUsedStocks,
                        totalWaste: this.totalWaste,
                        totalCutLoss: totalCutLoss,
                        averageWastePerStock: (this.totalWaste / totalUsedStocks).toFixed(2),
                        averageCutLossPerStock: (totalCutLoss / totalUsedStocks).toFixed(2),
                        overallUtilizationRate: (
                            (1 - (this.totalWaste + totalCutLoss) / 
                            (this.cuttingPlans.reduce((sum, plan) => sum + plan.stockLength, 0))) * 100
                        ).toFixed(2) + '%'
                    }
                };
            }
        }

        // 页面交互逻辑
        $(document).ready(function() {
            const stockLengths = new Set();
            let maxStockLength = 0; // 跟踪最大原材料长度

            // 添加原材料长度
            $('#addStockLength').click(function() {
                const length = parseFloat($('#newStockLength').val());
                if (!isNaN(length) && length > 0) {
                    stockLengths.add(length);
                    maxStockLength = Math.max(...stockLengths); // 更新最大长度
                    updateStockLengthsList();
                    updateCutLengthValidation(); // 更新切割长度验证
                    $('#newStockLength').val('');
                }
            });

            // 更新原材料长度列表显示
            function updateStockLengthsList() {
                const html = Array.from(stockLengths).map(length => `
                    <span class="stock-length-item">
                        <span>${length}mm</span>
                        <button type="button" class="btn btn-remove" 
                                onclick="removeStockLength(${length})">
                            <i class="fas fa-times"></i>
                        </button>
                    </span>
                `).join('');
                $('#stockLengthList').html(html);
            }

            // 删除原材料长度
            window.removeStockLength = function(length) {
                stockLengths.delete(length);
                maxStockLength = stockLengths.size > 0 ? Math.max(...stockLengths) : 0;
                updateStockLengthsList();
                updateCutLengthValidation(); // 更新切割长度验证
            };

            // 更新切割长度输入验证
            function updateCutLengthValidation() {
                const cutWidth = parseFloat($('#cutWidth').val()) || 4;
                const maxEffectiveLength = maxStockLength - cutWidth;
                
                $('.cut-length').each(function() {
                    $(this).attr('max', maxEffectiveLength);
                    
                    // 检查当前值是否超过新的最大值
                    const currentValue = parseFloat($(this).val());
                    if (!isNaN(currentValue) && currentValue > maxEffectiveLength) {
                        $(this).val(''); // 清空无效值
                        showInputError($(this), `切割长度不能超过${maxEffectiveLength}mm（原材料长度${maxStockLength}mm - 切割损耗${cutWidth}mm）`);
                    } else {
                        removeInputError($(this));
                    }
                });
            }

            // 显示输入错误提示
            function showInputError(input, message) {
                removeInputError(input); // 先移除已有的错误提示
                input.addClass('is-invalid');
                const errorDiv = $('<div>')
                    .addClass('invalid-feedback')
                    .text(message);
                input.after(errorDiv);
            }

            // 移除输入错误提示
            function removeInputError(input) {
                input.removeClass('is-invalid');
                input.next('.invalid-feedback').remove();
            }

            // 添加切割需求行
            $('#addCutRow').click(function() {
                const cutWidth = parseFloat($('#cutWidth').val()) || 4;
                const maxEffectiveLength = maxStockLength - cutWidth;
                
                const rowHtml = `
                    <div class="input-row">
                        <div class="row align-items-center">
                            <div class="col-length">
                                <input type="number" class="form-control cut-length" 
                                       placeholder="切割长度" step="0.01" min="1" max="${maxEffectiveLength}"
                                       required onchange="validateCutLength(this)">
                            </div>
                            <div class="col-quantity">
                                <input type="number" class="form-control cut-quantity" 
                                       placeholder="数量" min="1" required>
                            </div>
                            <div class="col-action">
                                <button type="button" class="btn btn-remove" 
                                        onclick="$(this).closest('.input-row').remove()">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                $('#cutRequirements').append(rowHtml);
            });

            // 切割长度验证函数
            window.validateCutLength = function(input) {
                const cutWidth = parseFloat($('#cutWidth').val()) || 4;
                const maxEffectiveLength = maxStockLength - cutWidth;
                const value = parseFloat(input.value);

                if (value > maxEffectiveLength) {
                    showInputError($(input), `切割长度不能超过${maxEffectiveLength}mm（原材料长度${maxStockLength}mm - 切割损耗${cutWidth}mm）`);
                    input.value = '';
                } else if (value > 0) {
                    removeInputError($(input));
                }
            };

            // 监听切割损耗宽度变化
            $('#cutWidth').on('change', function() {
                updateCutLengthValidation();
            });

            // 添加 Toast 相关函数
            function showToast(message, duration = 0) {
                const toastHtml = `
                    <div class="toast">
                        <div class="spinner-border text-light" role="status">
                            <span class="visually-hidden">计算中...</span>
                        </div>
                        <div>${message}</div>
                    </div>
                `;
                const $toast = $(toastHtml);
                $('.toast-container').append($toast);
                
                setTimeout(() => {
                    $toast.addClass('show');
                }, 100);

                if (duration > 0) {
                    setTimeout(() => {
                        hideToast($toast);
                    }, duration);
                }

                return $toast;
            }

            function hideToast($toast) {
                $toast.removeClass('show');
                setTimeout(() => {
                    $toast.remove();
                }, 300);
            }

            // 修改遮罩层控制函数
            function showOverlay() {
                const $overlay = $('.page-overlay');
                const $calculatingContent = $('.calculating-content');
                
                $overlay.css('display', 'flex').addClass('show');
                setTimeout(() => {
                    $calculatingContent.addClass('show');
                }, 50);
                $('body').addClass('calculating');
                
                // 禁用所有表单输入
                $('#cutForm input, #cutForm button').prop('disabled', true);
                
                // 添加进度动画
                let dots = 0;
                const progressInterval = setInterval(() => {
                    dots = (dots + 1) % 4;
                    $('.calculating-progress').text(`请耐心等待${'.'.repeat(dots)}`);
                }, 500);
                
                // 存储interval ID以便后续清除
                $overlay.data('progressInterval', progressInterval);
            }

            function hideOverlay() {
                const $overlay = $('.page-overlay');
                const $calculatingContent = $('.calculating-content');
                
                // 清除进度动画
                clearInterval($overlay.data('progressInterval'));
                
                $calculatingContent.removeClass('show');
                $overlay.removeClass('show');
                
                setTimeout(() => {
                    $overlay.css('display', 'none');
                    $('body').removeClass('calculating');
                    // 启用所有表单输入
                    $('#cutForm input, #cutForm button').not('[type="submit"]').prop('disabled', false);
                }, 400);
            }

            // 修改表单提交处理
            $('#cutForm').on('submit', async function(e) {
                e.preventDefault();
                
                const $submitBtn = $(this).find('button[type="submit"]');
                
                if ($submitBtn.prop('disabled')) {
                    return;
                }

                try {
                    // 显示遮罩层和计算提示
                    showOverlay();
                    
                    // 显示 Toast
                    const $toast = showToast('正在计算优化方案，请稍候...');

                    // 验证原材料长度
                    if (stockLengths.size === 0) {
                        throw new Error('请添加至少一个原材料长度');
                    }

                    // 获取并验证切割需求
                    const orders = [];
                    let hasError = false;
                    let totalPieces = 0;

                    $('.input-row').each(function() {
                        const lengthInput = $(this).find('.cut-length');
                        const quantityInput = $(this).find('.cut-quantity');
                        const length = parseFloat(lengthInput.val());
                        const quantity = parseInt(quantityInput.val());

                        // 验证输入值的有效性
                        if (isNaN(length) || length <= 0) {
                            showInputError(lengthInput, '请输入有效的切割长度');
                            hasError = true;
                            return false;
                        }

                        if (isNaN(quantity) || quantity <= 0) {
                            showInputError(quantityInput, '请输入有效的数量');
                            hasError = true;
                            return false;
                        }

                        const cutWidth = parseFloat($('#cutWidth').val()) || 4;
                        const maxEffectiveLength = maxStockLength - cutWidth;

                        if (length > maxEffectiveLength) {
                            showInputError(lengthInput, `切割长度不能超过${maxEffectiveLength}mm（原材料长度${maxStockLength}mm - 切割损耗${cutWidth}mm）`);
                            hasError = true;
                            return false;
                        }

                        totalPieces += quantity;
                        if (totalPieces > 1000) { // 添加合理的上限
                            throw new Error('切割件数总和不能超过1000件，请减少数量');
                        }

                        orders.push([length, quantity]);
                    });

                    if (hasError) {
                        return;
                    }

                    if (orders.length === 0) {
                        throw new Error('请添加至少一个切割需求');
                    }

                    // 获取其他参数
                    const cutWidth = parseFloat($('#cutWidth').val());
                    const minWaste = parseFloat($('#minWaste').val());

                    // 验证参数有效性
                    if (isNaN(cutWidth) || cutWidth < 0) {
                        throw new Error('请输入有效的切割损耗宽度');
                    }

                    if (isNaN(minWaste) || minWaste < 0) {
                        throw new Error('请输入有效的最小可接受废料长度');
                    }

                    // 使用 Web Worker 进行计算
                    const result = await new Promise((resolve, reject) => {
                        try {
                            const optimizer = new CuttingOptimizer(
                                Array.from(stockLengths),
                                orders,
                                {
                                    cutWidth: cutWidth,
                                    minWaste: minWaste,
                                    precision: 2,
                                    epsilon: 0.0001
                                }
                            );

                            const optimizeResult = optimizer.optimize();
                            resolve(optimizeResult);
                        } catch (error) {
                            reject(error);
                        }
                    });

                    // 验证结果
                    if (!result || !result.cuttingPlans || !Array.isArray(result.cuttingPlans)) {
                        throw new Error('计算结果无效，请检查输入参数');
                    }

                    // 验证是否所有切割需求都被满足
                    let totalCutPieces = result.cuttingPlans.reduce((sum, plan) => 
                        sum + plan.cuts.length, 0);
                    
                    if (totalCutPieces !== totalPieces) {
                        throw new Error('计算结果不完整，请调整参数重试');
                    }

                    // 显示结果
                    showResult(result);
                    
                    // 隐藏 Toast
                    hideToast($toast);
                    
                    // 显示成功 Toast
                    showToast('计算完成！', 3000);

                    // 启用所有输入和按钮，允许修改参数重新计算
                    enableInputs();
                } catch (error) {
                    console.error('计算错误:', error);
                    showError(error.message);
                } finally {
                    // 隐藏遮罩层和加载动画
                    hideOverlay();
                }
            });

            // 添加启用输入控件的函数
            function enableInputs() {
                // 启用所有输入框和按钮
                $('#cutForm input, #cutForm button').prop('disabled', false);
                
                // 启用添加原材料长度和切割需求的功能
                $('#addStockLength, #addCutRow').prop('disabled', false);
                
                // 移除计算中状态
                $('body').removeClass('calculating');
            }

            // 将resetForm函数定义在全局作用域
            window.resetForm = function() {
                // 清空原材料长度列表
                stockLengths.clear();
                $('#stockLengthList').empty();
                $('#newStockLength').val('');
                
                // 清空切割需求
                $('#cutRequirements').empty();
                
                // 重置参数到默认值
                $('#cutWidth').val('4');
                $('#minWaste').val('50');
                
                // 添加一个默认的切割需求行
                $('#addCutRow').click();
                
                // 清空结果区域
                $('.result-area').hide();
                $('#resultContent').empty();
                
                // 启用所有输入
                enableInputs();
            }

            // 添加重置按钮到表单
            $('#cutForm').append(`
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-secondary me-2" onclick="resetForm()">
                        <i class="fas fa-redo me-2"></i>重置参数
                    </button>
                </div>
            `);

            // 优化显示结果函数
            function showResult(result) {
                try {
                    $('.result-area').show();
                    let html = `
                        <div class="alert alert-success" role="alert">
                            <i class="fas fa-check-circle me-2"></i>计算完成！
                            <div class="float-end">
                                <button type="button" class="btn btn-sm btn-outline-success me-2" 
                                        onclick="$('#cutForm').get(0).scrollIntoView({behavior: 'smooth'})">
                                    <i class="fas fa-edit me-1"></i>修改参数
                                </button>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="exportToExcel()">
                                        <i class="fas fa-file-excel me-1"></i>导出Excel
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="exportToPDF()">
                                        <i class="fas fa-file-pdf me-1"></i>导出PDF
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="exportToImage()">
                                        <i class="fas fa-image me-1"></i>导出图片
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <ul class="nav nav-tabs result-tabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="visual-tab" data-bs-toggle="tab" 
                                        data-bs-target="#visual-result" type="button" role="tab">
                                    可视化展示
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="table-tab" data-bs-toggle="tab" 
                                        data-bs-target="#table-result" type="button" role="tab">
                                    表格展示
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="visual-result" role="tabpanel">
                                ${generateVisualResult(result)}
                            </div>
                            <div class="tab-pane fade" id="table-result" role="tabpanel">
                                ${generateTableResult(result)}
                            </div>
                        </div>
                    `;

                    $('#resultContent').html(html);
                } catch (error) {
                    console.error('显示结果错误:', error);
                    showError('显示结果时发生错误，请重试');
                }
            }

            // 生成可视化结果（原有的展示方式）
            function generateVisualResult(result) {
                let html = '';

                // 添加原材料使用统计
                if (result.summary && result.summary.stockUsage) {
                    html += `
                        <div class="alert alert-primary mb-4">
                            <h4 class="alert-heading mb-3">原材料使用统计</h4>
                            ${result.summary.stockUsage.map(item => `
                                <div><strong>${item.length}mm:</strong> ${item.count} 根</div>
                            `).join('')}
                            <hr>
                            <div class="mt-2">
                                <strong>合计总数：</strong>${result.summary.totalStocksUsed} 根
                            </div>
                        </div>
                    `;
                }

                // 添加切割方案详情
                if (result.cuttingPlans && Array.isArray(result.cuttingPlans)) {
                    result.cuttingPlans.forEach(plan => {
                        if (!plan || !plan.stockLength || !Array.isArray(plan.cuts)) {
                            console.error('无效的切割方案:', plan);
                            return;
                        }

                        const utilizationPercent = parseFloat(plan.utilizationRate) || 0;
                        const wastePercent = ((plan.waste || 0) / plan.stockLength) * 100;
                        const cutLossPercent = ((plan.cutLoss || 0) / plan.stockLength) * 100;

                        html += `
                            <div class="cutting-plan">
                                <h4>原材料 #${plan.stockNumber} (${plan.stockLength}mm)</h4>
                                <div><strong>切割长度:</strong> ${plan.cuts.join('mm, ')}mm</div>
                                <div><strong>废料长度:</strong> ${plan.waste}mm</div>
                                <div><strong>切割损耗:</strong> ${plan.cutLoss}mm</div>
                                <div><strong>利用率:</strong> ${plan.utilizationRate}</div>
                                
                                <div class="progress">
                                    <div class="progress-bar cut-piece" role="progressbar" 
                                         style="width: ${utilizationPercent}%" 
                                         title="有效利用: ${plan.utilizationRate}">
                                        ${plan.utilizationRate}
                                    </div>
                                    <div class="progress-bar cut-loss-piece" role="progressbar" 
                                         style="width: ${cutLossPercent}%" 
                                         title="切割损耗: ${cutLossPercent.toFixed(2)}%">
                                    </div>
                                    <div class="progress-bar waste-piece" role="progressbar" 
                                         style="width: ${wastePercent}%" 
                                         title="废料: ${wastePercent.toFixed(2)}%">
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                // 添加总体统计
                if (result.summary) {
                    html += `
                        <div class="alert alert-info mt-4">
                            <h4 class="alert-heading mb-3">总体统计</h4>
                            <div><strong>使用原材料总数:</strong> ${result.summary.totalStocksUsed || 0} 根</div>
                            <div><strong>总浪费长度:</strong> ${result.summary.totalWaste || 0}mm</div>
                            <div><strong>总切割损耗:</strong> ${result.summary.totalCutLoss || 0}mm</div>
                            <div><strong>平均每根浪费:</strong> ${result.summary.averageWastePerStock || 0}mm</div>
                            <div><strong>平均每根切割损耗:</strong> ${result.summary.averageCutLossPerStock || 0}mm</div>
                            <div><strong>整体利用率:</strong> ${result.summary.overallUtilizationRate || '0%'}</div>
                        </div>
                    `;
                }

                return html;
            }

            // 生成表格形式结果
            function generateTableResult(result) {
                let html = '';

                // 添加原材料使用统计表格
                if (result.summary && result.summary.stockUsage) {
                    html += `
                        <div class="table-responsive mb-4">
                            <h4 class="mb-3">原材料使用统计</h4>
                            <table class="result-table">
                                <thead>
                                    <tr>
                                        <th>原材料长度</th>
                                        <th>使用数量</th>
                                        <th>总长度</th>
                                        <th>占比</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    const totalStockLength = result.summary.stockUsage.reduce(
                        (sum, item) => sum + (item.length * item.count), 0
                    );

                    result.summary.stockUsage.forEach(item => {
                        const percentage = ((item.length * item.count) / totalStockLength * 100).toFixed(2);
                        html += `
                            <tr>
                                <td>
                                    <span class="badge-stock">${item.length}mm</span>
                                </td>
                                <td class="text-end">${item.count} 根</td>
                                <td class="text-end">${item.length * item.count}mm</td>
                                <td>
                                    <div class="utilization-cell">
                                        <div class="utilization-bar">
                                            <div class="utilization-progress" style="width: ${percentage}%"></div>
                                        </div>
                                        <span>${percentage}%</span>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });

                    html += `
                                    <tr class="table-light">
                                        <td><strong>合计</strong></td>
                                        <td class="text-end"><strong>${result.summary.totalStocksUsed} 根</strong></td>
                                        <td class="text-end"><strong>${totalStockLength}mm</strong></td>
                                        <td><strong>100%</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                // 切割方案表格
                html += `
                    <div class="table-responsive">
                        <h4 class="mb-3">切割方案明细</h4>
                        <table class="result-table">
                            <thead>
                                <tr>
                                    <th>序号</th>
                                    <th>原材料长度</th>
                                    <th>切割明细</th>
                                    <th>废料长度</th>
                                    <th>切割损耗</th>
                                    <th>利用率</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                result.cuttingPlans.forEach(plan => {
                    const utilizationPercent = parseFloat(plan.utilizationRate) || 0;
                    html += `
                        <tr>
                            <td>#${plan.stockNumber}</td>
                            <td>
                                <span class="badge-stock">${plan.stockLength}mm</span>
                            </td>
                            <td>
                                <ul class="cuts-list">
                                    ${plan.cuts.map(cut => `<li>${cut}mm</li>`).join('')}
                                </ul>
                            </td>
                            <td class="text-end">${plan.waste}mm</td>
                            <td class="text-end">${plan.cutLoss}mm</td>
                            <td>
                                <div class="utilization-cell">
                                    <div class="utilization-bar">
                                        <div class="utilization-progress" style="width: ${utilizationPercent}%"></div>
                                    </div>
                                    <span>${plan.utilizationRate}</span>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                // 总体统计表格
                if (result.summary) {
                    html += `
                        <div class="table-responsive mt-4">
                            <h4 class="mb-3">总体统计</h4>
                            <table class="summary-table">
                                <tbody>
                                    <tr>
                                        <th>使用原材料总数</th>
                                        <td>${result.summary.totalStocksUsed || 0} 根</td>
                                    </tr>
                                    <tr>
                                        <th>总浪费长度</th>
                                        <td>${result.summary.totalWaste || 0}mm</td>
                                    </tr>
                                    <tr>
                                        <th>总切割损耗</th>
                                        <td>${result.summary.totalCutLoss || 0}mm</td>
                                    </tr>
                                    <tr>
                                        <th>平均每根浪费</th>
                                        <td>${result.summary.averageWastePerStock || 0}mm</td>
                                    </tr>
                                    <tr>
                                        <th>平均每根切割损耗</th>
                                        <td>${result.summary.averageCutLossPerStock || 0}mm</td>
                                    </tr>
                                    <tr>
                                        <th>整体利用率</th>
                                        <td>${result.summary.overallUtilizationRate || '0%'}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                return html;
            }

            // 初始化添加一行切割需求
            $('#addCutRow').click();

            // 添加键盘事件处理
            $(document).on('keydown', function(e) {
                // 当遮罩层显示时，禁用 Enter 键提交表单
                if ($('.page-overlay').is(':visible') && e.keyCode === 13) {
                    e.preventDefault();
                    return false;
                }
            });

            // 添加导出功能函数
            window.exportToExcel = function() {
                try {
                    const workbook = XLSX.utils.book_new();
                    
                    // 原材料使用统计
                    const stockUsageData = [
                        ['原材料长度(mm)', '使用数量(根)', '总长度(mm)', '占比(%)']
                    ];
                    
                    $('.result-table tbody tr').not('.table-light').each(function() {
                        const row = [
                            $(this).find('.badge-stock').text().replace('mm', ''),
                            $(this).find('td:eq(1)').text().replace(' 根', ''),
                            $(this).find('td:eq(2)').text().replace('mm', ''),
                            $(this).find('.utilization-cell span').text().replace('%', '')
                        ];
                        stockUsageData.push(row);
                    });
                    
                    // 切割方案明细
                    const cutPlanData = [
                        ['序号', '原材料长度(mm)', '切割明细(mm)', '废料长度(mm)', '切割损耗(mm)', '利用率(%)']
                    ];
                    
                    $('.result-table:eq(1) tbody tr').each(function() {
                        const cuts = $(this).find('.cuts-list li').map(function() {
                            return $(this).text().replace('mm', '');
                        }).get().join(', ');
                        
                        const row = [
                            $(this).find('td:eq(0)').text().replace('#', ''),
                            $(this).find('.badge-stock').text().replace('mm', ''),
                            cuts,
                            $(this).find('td:eq(3)').text().replace('mm', ''),
                            $(this).find('td:eq(4)').text().replace('mm', ''),
                            $(this).find('.utilization-cell span').text().replace('%', '')
                        ];
                        cutPlanData.push(row);
                    });
                    
                    // 总体统计
                    const summaryData = [
                        ['指标', '数值']
                    ];
                    
                    $('.summary-table tr').each(function() {
                        const row = [
                            $(this).find('th').text(),
                            $(this).find('td').text()
                        ];
                        summaryData.push(row);
                    });
                    
                    // 创建工作表
                    const stockUsageSheet = XLSX.utils.aoa_to_sheet(stockUsageData);
                    const cutPlanSheet = XLSX.utils.aoa_to_sheet(cutPlanData);
                    const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                    
                    // 添加工作表到工作簿
                    XLSX.utils.book_append_sheet(workbook, stockUsageSheet, '原材料使用统计');
                    XLSX.utils.book_append_sheet(workbook, cutPlanSheet, '切割方案明细');
                    XLSX.utils.book_append_sheet(workbook, summarySheet, '总体统计');
                    
                    // 导出文件
                    const date = new Date().toISOString().slice(0, 10);
                    XLSX.writeFile(workbook, `切割优化方案_${date}.xlsx`);
                } catch (error) {
                    console.error('导出Excel错误:', error);
                    showToast('导出Excel失败，请重试', 3000);
                }
            };

            window.exportToPDF = async function() {
                try {
                    const element = document.querySelector('.result-area .card');
                    const date = new Date().toISOString().slice(0, 10);
                    
                    const opt = {
                        margin: 1,
                        filename: `切割优化方案_${date}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2 },
                        jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
                    };
                    
                    // 显示加载提示
                    const $toast = showToast('正在生成PDF，请稍候...');
                    
                    // 导出PDF
                    await html2pdf().set(opt).from(element).save();
                    
                    // 隐藏加载提示
                    hideToast($toast);
                    
                    // 显示成功提示
                    showToast('PDF导出成功！', 3000);
                } catch (error) {
                    console.error('导出PDF错误:', error);
                    showToast('导出PDF失败，请重试', 3000);
                }
            };

            // 添加导出图片功能
            window.exportToImage = async function() {
                try {
                    // 显示加载提示
                    const $toast = showToast('正在生成图片，请稍候...');
                    
                    // 获取结果区域元素
                    const element = document.querySelector('.result-area .card');
                    
                    // 确保所有内容都可见
                    const activeTab = element.querySelector('.tab-pane.active');
                    const allTabs = element.querySelectorAll('.tab-pane');
                    allTabs.forEach(tab => {
                        tab.classList.add('show', 'active');
                    });
                    
                    // 配置选项
                    const options = {
                        scale: 2, // 提高清晰度
                        useCORS: true, // 允许加载跨域图片
                        logging: false, // 关闭日志
                        backgroundColor: '#ffffff', // 设置白色背景
                        width: element.offsetWidth,
                        height: element.scrollHeight,
                        scrollY: -window.scrollY
                    };
                    
                    try {
                        // 生成图片
                        const canvas = await html2canvas(element, options);
                        
                        // 恢复原始标签页状态
                        allTabs.forEach(tab => {
                            tab.classList.remove('show', 'active');
                        });
                        if (activeTab) {
                            activeTab.classList.add('show', 'active');
                        }
                        
                        // 转换为图片并下载
                        const date = new Date().toISOString().slice(0, 10);
                        const link = document.createElement('a');
                        link.download = `切割优化方案_${date}.png`;
                        link.href = canvas.toDataURL('image/png', 1.0);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        // 隐藏加载提示
                        hideToast($toast);
                        
                        // 显示成功提示
                        showToast('图片导出成功！', 3000);
                    } catch (renderError) {
                        console.error('图片渲染错误:', renderError);
                        throw new Error('图片渲染失败，请重试');
                    }
                } catch (error) {
                    console.error('导出图片错误:', error);
                    showToast('导出图片失败，请重试', 3000);
                    
                    // 确保恢复原始标签页状态
                    const element = document.querySelector('.result-area .card');
                    const allTabs = element.querySelectorAll('.tab-pane');
                    allTabs.forEach(tab => {
                        tab.classList.remove('show', 'active');
                    });
                    const activeTab = element.querySelector('[data-bs-target].active');
                    if (activeTab) {
                        const targetId = activeTab.getAttribute('data-bs-target');
                        const targetTab = element.querySelector(targetId);
                        if (targetTab) {
                            targetTab.classList.add('show', 'active');
                        }
                    }
                }
            };
        });
    </script>
</body>
</html>
